# 网际协议：IPv4，寻址，IPv6
今天的因特网网络层著名的协议有**网际协议 (IP)**。有两个版本的IP正在使用，一个是IPv4，一个是IPv6。

## IPv4 数据报格式
网络层分组被称为数据报。IPv4的数据报格式如下所示：

![IPv4_message](https://res.cloudinary.com/harlan9613/image/upload/v1589889741/Computer_Network/IPv4_message_inyjco.png)

+ **版本号 / version**：4比特版本号规定了数据包的IP版本协议。通过版本号分别数据报是IPv4还是IPv6。路由器能通过数据报确认如何解释IP数据报的剩余部分。
+ **首部长度 / head.len**：IPv4数据报可包含一些可变数量的选项，故需要这4比特来确定IP数据报中的荷载实际开始的地方。大多数IP数据报不包含选项，所以一般的IP数据报具有20字节的首部。
+ **服务类型 / type of service**：使不同类型的数据报能够互相区别开来。
+ **数据报长度 / length**：这是IP数据报的总长度 (首部加上数据)，以字节计。因为长度为16个比特，所以IP数据报的理论最大长度为65535字节。
+ **标识，标志，片偏移 / identifier, flgs, offset**：与IP分片有关。标识用于区分数据报，标志用于区分该分片是否是最后一片，片偏移表示其在整个数据报中的位置。
+ **寿命 / time to live**：寿命字段用来确保数据报不会永远在网络循环中。每当一台路由器处理数据报时，该字段的值减1。若TTL字段减为0，则该数据报必须丢弃。
+ **协议 / upper layer**：该字段表明了IP数据报的数据部分应该交给哪个特定的运输层协议。协议号是将网络层与运输层绑定到一起的粘合剂。
+ **首部检验和 / header checksum**：首部检验和用于帮助路由器检测收到的IP数据报中的比特错误。每台路由器上必须重新计算检验和并再次存放到原处，因为TTL字段以及可能的选项字段会改变。
+ **源和目的IP地址 / source IP address，destination IP address**：表示生成该数据报的源IP地址和目的IP地址。通常源主机通过DNS查找来决定目的地址。
+ **选项 / options**：选项字段允许IP首部被扩展。
+ **数据 / data**：有效荷载。IP数据报中的数据字段包含要交付给目的地的运输层报文段。

IP数据报有总长为 20 字节的首部（假设无选项，则有160比特，为20字节）。如果数据报承载一个TCP报文段，则每个数据报共承载了总长40字节的首部。

## IPv4数据报分片
并不是所有的链路层协议都能承载相同长度的网络层分组。一个链路层帧能承载的最大数据量叫作**最大传送单元 (Maximum Transmission Unit, MTU)**。因为每个IP数据报封装在链路层帧中从一台路由器传输到下一台路由器，故链路层协议的MTU严格地限制着IP数据报地长度。对IP数据报长度具有严格限制并不是主要问题。问题在于发送方与目的地路径上地每段链路可能使用不同地链路层协议，且每种协议可能具有不同地MTU。

解决方法是将较大地IP数据报中的数据分片成两个或多个较小的IP数据报，用单独的链路层帧封装这些较小的IP数据报，然后通过输出链路发送这些帧。每个较小的数据报都称为**片**。

片在其到达目的地的运输层以前需要重新组装。IPv4的设计者决定将数据报的重新组装工作放到端系统中，而不是放到网络路由器中。

IPv4数据报中有标识，标志和偏移三个字段。目的地主机通过检查数据报的标识号以确定哪些数据报实际上是同一较大数据报的片。通过将最后一片的标志位设置成0，其他片的标志位设置成1来确定到来的片是否是最后一片。为了让目的主机确定是否丢失了一个片，使用偏移字段指定该片应放在初始IP数据报的哪个位置。

## IPv4 编址
一台主机通常只有一条链路连接到网络；当主机中的IP想发送一个数据报时，它就在该链路上发送。主机与物理链路之间的边界叫作**接口**。

路由器拥有两条或多条链路与它连接。路由器与它的任意一条链路之间的边界也叫做接口。一台路由器因此有多个接口，每个接口有其链路。因为每台主机与路由器都能发送和接收IP数据报，IP要求每台主机和路由器接口拥有自己的IP地址。

> 从技术上讲，一个IP地址与一个接口相关联，而不是与包括该接口的主句或路由器相关联。

每个IP地址长度为32比特，等价位4字节。这些地址按照**点分十进制记法**：

比如地址 193.32.216.9 的二进制为： 11000001 00100000 11011000 00001001

在全球因特网中的每台主机和路由器上的每个接口，都必须有一个全球唯一的IP地址。一个接口的IP地址的一部分需要由其连接的子网来决定。

![Subnet](https://res.cloudinary.com/harlan9613/image/upload/v1589892002/Computer_Network/Subnet_wa5wgd.png)

如果主机和路由器通过某种不包含路由器的网络互联起来，那么主机和路由器之间就形成了**子网 (subnet)**。子网中的IP地址将有一部分是相同的。而**子网掩码**就是表示所有子网IP中32比特里有多少个比特是相同的，这些相同的比特定义了这个子网。

上图中，子网的地址可以是 223.1.1.0/24，表示该子网内前24个比特是相同。任何其他要连接到该子网的主机都要其地址具有 223.1.1.xxx 的形式。

> 为了确定子网，分开主机和路由器的每个接口，产生几个隔离的网络岛，使用接口端接这些隔离的网络的端点。这些隔离的网络中的每一个都叫做一个子网。

![Num_subnet](https://res.cloudinary.com/harlan9613/image/upload/v1589892398/Computer_Network/Num_subnet_mfr5h2.png)

在上图中，共有6个子网。

原则上，不同的子网能够具有完全不同的子网地址。因特网中的地址分配策略被称为**无类别域间路由选择 (Classless Interdomain Routing, CIDR)**。当使用子网寻址时，32比特的IP地址被划分成两部分。

第一部分是前缀。一个组织通常被分配一块连续的地址，即具有相同前缀的一段地址。该组织内部的设备的IP将共享共同的前缀。当该组织外部的一台路由器转发一个数据报，且数据报的目的地址位于该组织内部时，外部路由器**只关注该组织IP的前缀部分**。前缀部分代表了这个组织内所有设备的IP。这样做减少了路由器中转发的长度。

第二部分是除去前缀的剩余部分。剩余比特用于区分该组织内部设备的，其中的所有设备具有相同的网络前缀。只有当组织内部的路由器转发分组时，才会考虑这些剩余比特。剩余比特可能具有另外的子网结构。

IP广播地址 255.255.255.255 表示当一台主机发出一个目的地址为广播地址的数据报时，该报文会交付给同一个网络中的所有主机。

## 地址获取

我们需要知道主机或子网最初是如何得到它们的地址的。先看组织是如何为其设备得到一个地址块的，再看一个设备是如何从某组织的地址块中分配到一个地址的。

**1. 获取一块地址**

为了获取一块IP地址用于一个组织的子网内，某网络管理员也许首先会与他的ISP联系，该ISP可能会从已分给它的更大地址块中提供一些地址。

另一种方式是通过IP地址管理组织获取IP地址。非盈利的ICANN组织不仅分配IP地址，还管理DNS根服务器。

**2. 获取主机地址：动态主机配置协议**

某组织一旦获得了一块地址，它就可以为本组织内的主机与路由器接口逐个分配IP地址。**动态主机配置协议 (Dynamic Host Configuration, DHCP)** 允许主机自动获取一个IP地址。网络管理员能够配置DHCP，以使某给定主机每次与网络连接时能得到一个相同的IP地址，或者某主机将被分配一个临时的IP地址。

对于一台新到达的主机，DHCP一般分为4个步骤：

![DHCP](https://res.cloudinary.com/harlan9613/image/upload/v1589894016/Computer_Network/DHCP_ph1mri.png)

+ **DHCP服务器发现**：一台新到达的主机的首要任务是发现一个要与其交互的DHCP服务器。这可通过使用DHCP发现报文来完成。DHCP客户生成包含DHCP发现报文的IP数据报，其中使用广播目的地址 255.255.255.255 并且使用本主机源IP地址 0.0.0.0。DHCP客户将该IP数据报传递给链路层，链路层然后将该帧广播到所有与该子网连接的节点。
+ **DHCP服务器提供**：DHCP服务器收到一个DHCP发现报文时，用DHCP提供报文向客户做出相应。仍使用IP广播地址 255.255.255.255 来进行。因为子网中可能存在几个DHCP服务器，该客户也许会发现它处于能在几个提供者之间进行选择的位置。每台服务器提供的报文包含收到的发现报文的事务ID，向客户推荐的IP地址，网络掩码以及IP地址租用期，即IP地址有效的时间量。
+ **DHCP请求**：新到达的客户从一个或多个服务器中选择一个，并向选中的服务器提供DHCP请求报文进行相应。
+ **DHCP ACK**：服务器用DHCP ACK报文对DHCP请求报文进行相应，证实所要求的参数。

一旦客户收到DHCP ACK后，交互便完成了。DHCP有着严重的缺陷，因为每当节点连到一个新子网，要从DHCP得到一个新的IP地址，当一个移动节点在子网间移动时，就不能维持与远程应用之间的TCP连接。

## 网络地址转换
每个IP使能的设备都需要一个IP地址。当子网变大，需要重新分配一块较大的连续地址时，需要用到**网络地址转换 (Network Address Translation, NAT)**。

![NAT](https://res.cloudinary.com/harlan9613/image/upload/v1589895265/Computer_Network/NAT_v5hkpp.png)

如上图，位于家中的NAT路由器有一个接口，接口右侧是家庭网络的一部分。家庭网络内的编址就是 10.0.0/24。这些地址用于家庭网络等专用网络或具有专用地址的地域。具有专用地址的地域是指其地址仅对该网络中的设备有意义的网络。

考虑到许多家庭网络中都存在着 10.0.0/24 这样的编码，但仅在给定的网络中才有意义。所以这个编址相当于一种**相对于内部的**编址。

NAT使能路由器对于外部世界来说行为就如同一个具有单一IP地址的单一设备。所有离开家庭路由器流向更大因特网的报文都拥有一个源IP。从本质上讲，NAT对外界隐藏了家庭网络的细节。路由器和家庭设备的IP获取也是通过DHCP。

NAT通过**NAT转换表**来知晓到达的数据报将转发给哪个内部主机。表项中包含了端口号及其IP地址。NAT会根据发送主机的端口进行映射。

对于外部网络来说，他们只能看见NAT路由器给他们提供的IP地址和端口号。当NAT路由器收到数据段后，根据其NAT转换表中的端口号对应项来知道当前的数据段是发送给哪个家庭网络成员的。

**NAT存在的问题**是路由器是网络层的设备，但是NAT违反了主机应当直接彼此对话的原则，没有干涉节点修改IP地址，端口号。
