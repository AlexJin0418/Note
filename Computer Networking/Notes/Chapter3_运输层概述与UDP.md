# 运输层
什么是运输层：运输层是网络体系层级中的一层，位于应用层和网络层之间。运输层通过套接字接口获取应用层传输的报文，并将报文转换成运输层分组后传递给网络层来实现不同主机上进程之间的通信。

## 概述和运输层服务
运输层协议为不同主机上的应用进程之间提供了**逻辑通信 (Logic communication)**。通过逻辑通信，运行不同进程的主机好像直接相连一样。

### 运输层和网络层的关系
网络层提供了主机之间的逻辑通信，而运输层为运行在不同主机上的进程之间提供了逻辑通信。

运输层协议只工作在端系统中。在端系统中，运输层协议将来自应用进程的报文移动到网络边缘(即网络层)。但对有关这些报文在网络核心如何移动并不作任何规定。

计算机网络中可以安排多种运输层协议，每种协议为应用程序提供不同的服务模型。

运输协议能够提供的服务常常受制于底层网络协议的服务模型，如时延和带宽。同时运输层协议也能够提供底层网络协议无法提供的服务，如运输层提供可靠的数据传输服务，以及确保文件的机密性。

### 因特网运输层概述
因特网为应用层提供了两种运输层协议：**TCP**和**UDP**。应用程序开发人员必须指定一个运输层协议。

网络层协议叫做IP，网际协议，为不同的主机之间提供逻辑通信，是一种不可靠服务。而UDP和TCP的最基本责任是，将两个端系统间IP的交付服务扩展为运行在端系统上的两个进程之间的交付服务。将主机间交付扩展到进程间交付被称为**运输层的多路复用 (transport-layer multiplexing)** 与**多路分解 (demultiplexing)**。

**UDP提供不可靠服务：**
1. 提供最基本的进程到进程的数据交付
2. 和完整性检查

**TCP提供可靠数据传输服务：**
1. 将不可靠IP服务转换成进程间的可靠服务
2. 提供拥塞控制

## 多路复用与多路分解
**运输层的多路复用与多路分解：** 将由网络层提供的主机到主机交付服务延伸到为运行在主机上的应用程序提供进程到进程的交付服务。多路复用和多路分解是所有计算机网络都需要的。

在目的主机，运输层从紧临其下的网络层接收报文段。运输层负责将这些报文段中的数据交付给主机上运行的是当应用程序进程。

一个进程有一个或多个**套接字**，它相当于从网络向进程传递数据和从进程向网络传递数据的门户。在任意时刻，主机上可能有不止一个套接字，所以每个套接字都有唯一的标识符。

**多路分解 (demultiplexing)：** 在接收端，运输层检查报文字段，标识出接收套接字，进而将报文段定向到该套接字。将运输层报文段中的数据交付到正确的套接字上。

**多路复用 (multiplexing)：** 在源主机从不同套接字中收集数据块，并为每个数据块封装上首部信息从而生成报文段，然后将报文段传递到网络层。

运输层多路复用要求：1. 套接字有唯一标识符；2. 每个报文段有特殊字段来指示该报文段所要交付到的套接字。

特殊字段指的是**源端口号字段 (source port number field)** 和**目的端口号字段 (destination port number field)**。端口号是一个16比特的数，其大小在0 ~ 65535之间。0 ~ 1023 范围的端口号称为**周知端口号 (well-known port number)**，是受限制的。

多路分解服务：在主机上的每个套接字能够分配一个端口号，当报文段到达主机时，运输层检查报文段中的目的端口号，并将其定向到相应的套接字。然后报文段中的数据通过套接字进入其所连接的进程。

**1. 无连接的多路复用与多路分解**
当UDP套接字创建时，运输层自动地为该套接字分配一个端口号。通常，应用程序的客户端让运输层自动地分配端口号，而服务器端则分配一个特定的端口号。

假定主机A中有一个进程具有UDP端口，它要发送一个应用程序数据块给位于主机B中的一个进程。主机A中的运输层创建一个运输层报文段，其中包括应用程序数据，源端口号，目的端口号和两个其他值。网络层将该报文段封装到一个IP数据报中，并尽力而为地将报文段交付给接收主机B。如果该报文段到达接收主机B，接收主机运输层就检查该报文段中的目的端口号并将该报文段交付给端口号所标识的套接字。

一个UDP套接字是由一个二元组全面标识的，该二元组包含一个**目的IP地址**和一个**目的端口号**。对于两个不同源IP或不同源端口号的UDP报文段，如果具有相同的IP地址和目的端口号，它们将通过相同的目的套接字被定向到相同的目的进程。

**2. 面向连接的多路复用与多路分解**
TCP套接字是由一个四元组(**源IP地址，源端口号，目的IP地址，目的端口号**)来标识的。因此当TCP报文段到达时，主机将使用全部4个值来将报文段定向到相应的套接字。

服务器主机可以支持很多并行的TCP套接字，每个套接字与一个进程相联系，并由其四元组来标识每个套接字。当一个TCP报文段到达主机时，所有4个字段将被用来将报文段定向到相应的套接字。

**3. Web服务器与TCP**
连接套接字与进程之间并非总是有着一一对应的关系。

高性能的Web服务器通常只使用一个进程，但是为每个新的客户连接创建一个具有新连接套接字的新线程。对于这样一台服务器，在任意给定的时间内都有可能有许多连接套接字连接到相同的进程。

如果客户与服务器使用非持续HTTP，则对每一对请求和响应都创建一个新的TCP连接并在随后关闭，因此对每一对请求和响应创建一个新的套接字并在随后关闭。这种套接字的频繁创建和关闭会严重地影响一个繁忙的Web服务器的性能。

## 无连接运输：UDP
运输层最低限度必须提供一种复用/分解服务，以便在网络层与正确的应用级进程之间传递数据。

UDP只是做了运输协议能够做的最少工作。使用UDP时，在发送报文段之前，发送方和接收方的运输层实体之间没有握手。正因为如此，UDP被称为是**无连接的**。

UDP做为运输层首选的原因：
1. **关于发送什么数据以及何时发送的应用层控制更加精细。** 因为UDP没有拥塞控制机制，UDP会将应用层传递的数据立即打包进UDP报文段并立即传递给网络层。所以UDP拥有较小的传送延迟，但同时会有一些数据丢失。
2. **无须连接建立。** 与TCP连接需要三次握手不同，UDP不需要任何准备即可进行数据传输。因此UDP不会引入建立连接的时延。
3. **无连接状态。** 因为UDP不需要建立连接并且没有拥塞控制，所以UDP不需要维持连接状态并且追踪相应的参数。
4. **分组首部开销小。** UDP报文段只有8字节的首部开销，而TCP有20字节的首部开销。

UDP是不可靠连接，无法保证数据完整的传输，所以像电子邮件，远程终端访问和Web及文件传输都使用TCP连接。对于多媒体应用如因特网电话，实时视频和流式储存音频和视频等可以忍受少量分组丢失并需要低延时的应用来说则大多使用UDP运输层协议。

但同时，UDP中缺乏拥塞控制能够导致UDP发送方和接收方之间的高丢包率，并挤垮了TCP会话。

UDP应用虽然不提供可靠传输，但是可以通过应用程序自身建立可靠性机制来完成可靠传输。

### UDP报文段结构
UDP报文包括首部和应用层数据两部分。UDP报文段首部包括4个字段，每个字段由两个字节组成。首部包括了**源端口号，目的端口号，长度和检验和**。应用层数据包括了报文的内容。首部中长度表示应用数据中报文的长度。检验和则用来检测从源端口到目的端口之间传输是否出现了差错。

### UDP检验和
UDP检验和用于确定当UDP报文段从源到达目的地移动时，其中的比特是否发生了改变。发送方的UDP对报文段中的所有16比特字的和进行反码运算，求和时遇到的任何溢出都被回卷。

在接收方，全部的比特字加上检验和一起。如果该分组中没有引入差错，则显然在接收方处该和将是 111111111111111。如果这些比特之一是0.那么该分组中出现了差错。

**UDP提供运输层检验和：** 原因在与不能保证源和目的之间的所有链路都提供差错检测；同时无法确保路由器内存中的差错检测。所以如果端到端之间数据传输服务要提供差错检测，UDP就必须在端到端基础上在运输层提供差错检测。

虽然UDP提供差错检测，**但它对差错恢复无能为力**。UDP某种实现会丢弃受损的报文段，或者将受损的报文段交给应用程序并发出警告。
