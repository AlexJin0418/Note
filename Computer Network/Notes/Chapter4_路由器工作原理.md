# 路由器工作原理
路由器实现了网络层中的转发功能，即数据平面。

![router_architecture](https://res.cloudinary.com/harlan9613/image/upload/v1589814295/Computer_Network/router_architecture_qntd44.png)


路由器由4个组件组成：
![router_sender_protocol](https://res.cloudinary.com/harlan9613/image/upload/v1589814295/Computer_Network/router_sender_protocol_zqlsox.png)
+ **输入端口：** 最左侧方框执行终结入物理链路的物理层功能。中间的方框执行与位于入链路远端的数据链路层交互来执行数据链路层功能。右侧的方框执行查找功能，在这里，通过查询转发表决定路由器的输出端口，到达的分组通过路由器的交换结构转发到输出端口。
+ **交换结构：** 交换结构将路由器的输入端口连接到它的输出端口。这种交换结构完全包含在路由器之中。
+ **输出端口：** 输出端口储存从交换结构接收的分组，并通过执行必要的链路层和物理层功能在输出链路上传输这些分组。
+ **路由选择处理器：** 路由选择处理器执行控制平面功能。在传统路由器中，它执行路由选择协议，维护路由选择表与关联链路状态信息，并为该路由器计算转发表。在SDN路由器中，路由选择处理器负责与远程控制器通信，目的是接收由远程控制器计算的转发表项。

## 输入端口处理和基于目的地转发
在输入端口处执行的查找对于路由器运行是十分关键的。在这个地方，路由器使用转发表来查找输出端口，使得到达的分组能经过交换结构转发到该输出端口。

考虑到使用32比特的IP地址，我们将地址分成4个不同的地址范围，每个范围对应一个链路接口和。

![forwarding_table](https://res.cloudinary.com/harlan9613/image/upload/v1589814619/Computer_Network/forwrding_table_usuh4l.png)

使用这种风格的转发表，路由器用分组的目的地址的前缀与该表中的表项进行匹配；如果存在一个匹配项，则路由器向该匹配项关联的链路转发分组。

![longest_prefix_matching](https://res.cloudinary.com/harlan9613/image/upload/v1589814618/Computer_Network/longest_prefix_matching_zmipih.png)

当有多个匹配项时，路由器使用**最长前缀匹配规则 (longest prefix matching rule)**；即在该表中寻找最长的匹配项，并向与最长前缀匹配相关联的链路接口转发分组。

一旦通过查找确定了某分组的输出端口，则该分组就可以发送进入交换结构。在某些设计中，如果来自其他输入输出端口的分组当前正在使用该交换结构，一个分组可能会在进入交换结构时被暂时阻塞。

输入端口查找目的IP地址(匹配)，然后发送该分组进入交换结构(动作)的步骤是一种“匹配加动作”的抽象特定情况。匹配加动作这种抽象在网络设备中无处不在。

## 交换
交换结构位于一台路由器的核心部位，因为正是通过这种交换结构，分组才能实际地从一个输入端口交换到一个输出端口。

![switching_fabrics](https://res.cloudinary.com/harlan9613/image/upload/v1589815000/Computer_Network/switching_fabrics_yy8lp6.png)

+ **经内存交换：** 最简单，最早的路由器是传统的计算机，在输入端口与输出端口之间的交换是在CPU的直接控制下完成的。不能同时转发两个分组，即使它们有不同的目的端口，因为经过共享系统总线一次仅能执行一个内存读/写。

+ **经总线交换：** 输入端口经一根共享总线将分组直接传输到输出端口，不需要路由器选择处理器的干预。通过添加标签使得分组被输出端口识别。因为一次只有一个分组能够跨越总线，所以同时到达的分组必须等待总线上的分组。

+ **经互联网络交换：** 克服单一，共享式总线带宽限制的一种方法是，使用一个更复杂的互联网络。每条垂直的总线在交叉点与每条水平的总线交叉，交叉点通过交换结构控制器能够在任何时刻开启和闭合。纵横式网络能够并行转发多个分组。但如果来自两个不同输入端口的分组拥有相同的目的端口，那么一个分组必须在输入端等待。

更为复杂的互联网络使用多级交换元素，以使来自不同输入端口的分组通过交换结构同时朝着相同的输出端口前行。

## 输出端口处理
输出端口处理取出已经存放在输出端口内存中的分组并将其转发到输出链路上。

## 何处出现排队
在输入端口和输出端口都可以形成分组队列。排队的位置和程度将取决于流量负载，交换结构的相对速率和线路速率。随着队列的增长，路由器缓存空间将会耗尽，当无内存可用于存储分组时会出现丢包。

假定输入线路和输出线路速度是相同的，并且有相同数量的输入端口和输出端口，都为N。我们假定交换速率是输入输出线路速度的N倍。那么在每一时刻，都有N个分组在输入线路内从链路层被传入，同时交换结构能够在相同时间内处理这些出现的分组。所以每批N个分组能够在下一批到达前通过交换结构处理完毕。

**1. 输入排队**
在以上假定中，交换结构能够使所有到达的分组无延迟通过它进行传送。但如果交换结构速率小于传输速率呢。这种情况下，在输入端口也将出现分组排队，因为到达的分组必须加入输入端口队列中，以等待通过交换结构传送到输出端口。假定一个分组能够以接收端接收一个分组相同的时间通过任意输入端口到达输出端口。那么从输入队列移动到要求的输出队列中，只要其输出端口不通，多个分组可以被并行传送。然而，如果位于两个输入队列前端的两个分组是发往同一输出队列的，则其中的一个分组将被阻塞。

![HOL](https://res.cloudinary.com/harlan9613/image/upload/v1589816020/Computer_Network/HOL_gesuw4.png)

考虑红色的分组，因为同一时间输出端口只能接收一个分组，所以下方的绿色分组即便是去往右下方没有分组到达的端口，也因为前面的红色分组阻塞而被迫等待。这种现象叫作输入排队交换机中的**线路前部 (Head-Of-the-Line, HOL)** 阻塞。即在一个输入队列中排队的分组必须等待通过交换结构发送，因为它被位于线路前部的另一个分组所阻塞。

**2. 输出排队**
即便交换结构能够在同一时间处理所有的输入分组，使输入端口减少队列的形成，但是分组队列能够在输出端口形成。排队的分组数量能够变得足够大，耗尽输出端口的可用内存。

当形成队列时，输出端口的**分组调度 (packet scheduler)** 在这些排队分组中选择一个分组来传输。

发送端缓存的大小由平均往返时延，链路的容量以及通过链路的流量决定

![sender_buffer](https://res.cloudinary.com/harlan9613/image/upload/v1589816445/Computer_Network/sender_buffer_w3duie.png)

## 分组调度
分组调度解决排队的分组如何经输出链路传输的问题。

**1. 先进先出**

![FIFO](https://res.cloudinary.com/harlan9613/image/upload/v1589816569/Computer_Network/FIFO_scheduling_dyvrrm.png)

FIFO调度规则按照分组到达的输出链路队列的相同次序来选择分组在链路上传输。利用FIFO规则，分组按照到达的相同次序离开。

**2. 优先权排队**

![priority](https://res.cloudinary.com/harlan9613/image/upload/v1589816769/Computer_Network/priority_k4itw8.png)

在优先权排队的规则下，到达输出链路的分组被分类放入输出队列的优先权类。当选择一个分组传输时，优先权排队规则将从队列为非空的最高优先权类中传输一个分组。同一优先权的分组之间的选择通常以FIFO的方式完成。

**3. 循环加权公平排队**

![round_robin](https://res.cloudinary.com/harlan9613/image/upload/v1589816990/Computer_Network/round_robin_vnhhly.png)

在循环排队规则下，分组像使用优先权排队那样被分类。然而，在类之间不存在严格的服务优先权，循环调度器在这些类之间轮流提供服务。

在有任何分组排队等待传输时，不允许链路保持空闲。当寻找给定类的分组但是没有找到时，保持工作的循环规则将立即检查循环列序中的下一类。

**加权公平排队规则：** 给与每一个类不同的权重，所以每个类在任何时间间隔内可能收到不同数量的服务。
