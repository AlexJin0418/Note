# 第4章 文件系统

## 4.4
### 4.4.4 文件系统性能
访问磁盘比访问内存慢得多。所以许多文件系统采用了各种优化措施以改善性能。

#### 1. 高速缓存
最常用的减少磁盘访问次数技术是**块高速缓存(block cache)**或者**缓冲区高速缓存(buffer cache)**。

高速缓存逻辑上属于磁盘，但实际上基于性能的考虑被**保存在内存内**。

高速缓存的常用算法是：读取全部的读请求，查看在高速缓存中是否有所需要的块。如果存在，可执行读操作而无须访问磁盘。如果该块不在高速缓存中，首先要把它读到高速缓存，再复制到所需的地方。

![高速缓存](https://res.cloudinary.com/harlan9613/image/upload/v1586920819/IMG/4.28_gtrkks.png)

高速缓存常用的方法是将设备和磁盘地址进行散列操作(**4-28**)，在散列表中查找结果。具有相同散列值的块在一个散列表中连接在一起。使用LRU算法进行维护。

对于高速缓存的LRU算法需要考虑两点：
1. 这一块是否不久后会再次使用？
2. 之一块是否与文件系统一致性有本质的联系？

第一个问题。可以将块根据功能分为不同的块，比如i节点，间接块，目录块，满数据块，部分数据块等。把有可能最近不再需要的块放在LRU链表前部，于是它们所占用的缓冲区可以很快被重用。对很快就可能再次使用的块，比如正在写入的部分满数据块，可放在链表的尾部，这样能在高速缓存中保存较长的一段时间。

第二个问题。关系到文件系统的一致性。我们不希望发生系统崩溃时，正在编辑的文件丢失掉。Unix系统的处理方式基于其磁盘都是**硬盘**的环境，调用`sync`强制性地把全部修改过地块立即写回磁盘。这个系统调用会在一定地时间内循环执行。而windows的处理方式基于其早期磁盘都是**软盘**的环境。只要高速缓存中写入了块，那么所有被修改过的块都会被写入磁盘中。

#### 2. 块提前读
块提前读是指在需要用到块之前，试图提前将其写入高速缓存，从而提高命中率。如果请求文件系统在某个文件中生成块k，那么文件系统会为块k+1安排一个预读，因为文件系统希望在需要用到该块时，它已经在高速缓存或者马上就要在高速缓存中。

块提前读的策略适用于**实际顺序读取**的文件。对**随机读取**的文件，块提前读会读取无用的块以及从高速缓存中删除有用的块并占用磁盘带宽。

对于文件的访问方式，可以使用与文件相关联的某个位协助跟踪该文件到底是“顺序访问方式”还是“随机访问方式”。如果不能确定，那么可以首先预设文件为顺序访问方式。如果查找结果为随机访问，那么修改该位即可。这样，文件系统可以通过合理猜测来确定是否应该采用块提前读的策略。

#### 3. 减少磁盘臂运动
另一种技术是把有可能顺序访问的块放在一起，最好是在同一柱面上，从而**减少磁盘臂的移动次数**。

在使用i节点或者任何类似i节点的系统中，另一个性能瓶颈是，读取一个很短的文件也需要两次磁盘访问：一次是访问i节点，另一次是访问块。改进方法是，在磁盘中部而不是开始存放处存放i节点。或者将磁盘分成多个柱面组，每个柱面组有自己的i节点，数据块和空闲表。这样可以减少磁盘臂的移动次数。

### 4.4.5 磁盘碎片整理
随着时间流逝，文件被不断地创建与删除，于是磁盘会产生很多碎片，文件与空穴到处都是。结果是，当创建一个新文件时，它使用地块会散布在整个磁盘上，造成性能地降低。

磁盘性能可以通过如下方式恢复：移动文件使它们相邻，并把所有的空闲空间放在一个或者多个大的连续的区域内。

磁盘碎片整理程序会在一个在分区末端的连续区域内有大量空闲空间的文件系统上很好地运行。这段空间会允许磁盘碎片整理程序在分区开始端的文件碎片，并复制它们所有的块放到空闲空间内。这个动作在磁盘开始处释放出一个连续的块空间。

固态硬盘不受磁盘碎片的影响。



## 4.5 文件系统实例

### 4.5.1 MS-DOS文件系统



